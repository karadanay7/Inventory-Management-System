@page "/app/administration/products/orders"
@page "/app/administration/products/orders/{OrderStateParam}"
@rendermode InteractiveServer

@using Application.DTO.Response.Orders
@using Application.DTO.Request.Orders
@using Microsoft.AspNetCore.Components.Authorization
@using Application.Service.Products.Queries.Products
@using Application.DTO.Response.Products
@using Application.DTO.Response
@using Application.DTO.Request.Orders
@using MediatR
@using Mapster
@using Application.Service.Orders.Commands
@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.Toast.Configuration

<PageTitle>Orders</PageTitle>

<div class="mx-auto min-h-screen bg-base-200 p-4">
    <AdminHomeHeader />
<BlazoredToasts Position="ToastPosition.BottomRight" />
    <div class="flex flex-col md:flex-row">
        <div class="w-full md:w-1/4">
        
            <div class="card shadow-lg bg-base-100">
                <div class="card-body">
                    <div class="form-control mb-4">
                        <input type="text" placeholder="Search Order" @oninput="SearchOrder" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <select class="select select-bordered" @onchange="(e) => FilterOrders(e.Value?.ToString())">
                            <option value="">All States</option>
                            @foreach (var state in OrderStates)
                            {
                                <option value="@state">@state</option>
                            }
                        </select>
                    </div>
                    <div class="form-control mt-4">
                        <button class="btn btn-primary" @onclick="OpenCreateOrderModal">Create Order</button> 
                    </div>
                </div>
            </div>
        </div>
        
        <div class="w-full md:w-3/4">
            <div class="card shadow-lg bg-base-100">
                <div class="card-body">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr>
                                    <th>Client Name</th>
                                    <th>State</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in TemporalOrders)
                                {
                                    <tr>
                                        <td>@order.ClientName</td>
                                        <td>@order.State</td>
                                        <td>
                                            <button class="btn btn-primary" @onclick="@(e => OpenEditOrderModal(order.Id))">Edit</button>
                                            <button class="btn btn-error" @onclick="@(e => OpenConfirmationModal(order.Id))">Delete</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between mt-4">
                        <button class="btn btn-primary" @onclick="PreviousPage">Previous</button>
                        <button class="btn btn-primary" @onclick="NextPage">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Order Modal -->
    @if (IsOpen) // Check if this condition is met
    {
        <div class="modal modal-open">
            <div class="modal-box bg-base-200">
                <h2 class="font-bold text-lg">@OrderModalTitle</h2>
                <EditForm Model="@OrderModel" OnValidSubmit="SaveOrder">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="form-group">
                        <label for="name" class="label">ClientID</label>
                        <InputText id="name" class="input w-full" @bind-Value="OrderModel.ClientId" />
                    </div>
                   
                    <div class="form-group">
                        <label for="quantity" class="label">Quantity</label>
                        <InputNumber id="quantity" class="input w-full" @bind-Value="OrderModel.Quantity" />
                    </div>
                    <div class="form-group">
                        <label for="productId" class="label">Product</label>
                        <InputSelect id="clientId" class="select select-bordered w-full" @bind-Value="OrderModel.ProductId">
                            <option value="">Select Product</option>
                            @foreach (var product in Products)
                            {
                                <option value="@product.Id">@product.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="form-group mt-4 flex justify-between">
                        <button type="submit" class="btn btn-primary">Create</button>
                        <button type="button" @onclick="CloseOrderModal" class="btn btn-secondary">Cancel</button>
                    </div>
                   
                 
                </EditForm>
            </div>
        </div>
    }

    <!-- Confirmation Modal -->
     @if (IsConfirmationModalOpen)
    {
        <div class="modal modal-open">
            <div class="modal-box bg-base-200">
                <h2 class="font-bold text-lg">Confirm Order Deletion</h2>
                <p>Are you sure you want to delete this order?</p>
                <div class="modal-action">
                    @if (Loading)
                    {
                        <button class="btn btn-danger" disabled>
                            <span class="loading loading-dots loading-sm"></span> Deleting
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-danger" @onclick="ConfirmDelete">Confirm</button>
                    }
                    <button class="btn btn-secondary" @onclick="CloseConfirmationModal">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    public bool Loading { get; set; } = false;
    public bool IsOpen { get; set; } = false;
    public bool IsConfirmationModalOpen { get; set; } = false;
    [CascadingParameter] public Task<AuthenticationState>? UserAuthState { get; set; }
    private IEnumerable<GetOrderResponseDTO> TemporalOrders { get; set; } = [];
    private IEnumerable<GetOrderResponseDTO> PermanentOrders { get; set; } = [];
    private UpdateClientOrderRequestDTO UpdateOrderModel { get; set; } = new();

    private CreateOrderRequestDTO OrderModel { get; set; } = new();
   private IEnumerable<GetProductResponseDTO> Products { get; set; } = Enumerable.Empty<GetProductResponseDTO>();

    [Parameter] public string? OrderStateParam { get; set; }
    ClaimsPrincipal? User;
    private List<string> OrderStates = new() { $"{OrderState.Processing}", $"{OrderState.Delivered}", $"{OrderState.Cancelled}" };
    private Guid SelectedOrderId { get; set; } = Guid.Empty;
    private int CurrentPage { get; set; } = 1;
    private int TotalPages { get; set; } = 1;
    private string OrderModalTitle { get; set; } = "Create Order";
    private string OrderModalButtonText { get; set; } = "Create";
    private HubConnection? hubConnection;

    [Inject]
    private NavigationManager NavigationManager { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Loading = true;
        await GetUserIdentity();
        await GetOrders();
        await GetDefaults();
        Loading = false;

        hubConnection = netcodeHubConnectionService.GetHubConnection();
        hubConnection.On<string>("Notify", async (clientId) => await CallWhenNotified());
        if (hubConnection.State == HubConnectionState.Disconnected) await hubConnection.StartAsync();
    }

    async Task CallWhenNotified()
    {
        await GetOrders();
        await InvokeAsync(async () => await adminState.GetActiveOrdersCount());
    }
       private async Task GetDefaults()
    {
        await GetProducts();
       
    }

    private async Task GetOrders()
    {
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new GetAllOrdersQuery());
        TemporalOrders = result;
      
    }

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(OrderStateParam) || !homeGenericState.IsAdmin)
            return;

        StateGeneralMethod();
    }

    void StateGeneralMethod()
    {
        string state = homeGenericState.StateName;
        PermanentOrders = TemporalOrders.Where(o => o.State.Equals(state, StringComparison.OrdinalIgnoreCase));
        StateHasChanged();
    }
  

    private async Task SearchOrder(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        var searchText = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(searchText))
        {
            TemporalOrders = PermanentOrders;
        }
        else
        {
            TemporalOrders = PermanentOrders.Where(o => o.ClientName.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }
        StateHasChanged();
    }

    private void OpenCreateOrderModal() // Ensure this method is executed
    {
        OrderModel = new CreateOrderRequestDTO();
        OrderModalTitle = "Create Order";
        OrderModalButtonText = "Create";
        IsOpen = true; // This should trigger the modal to open
    }

    private void CloseOrderModal()
    {
        IsOpen = false;
        UpdateOrderModel = new UpdateClientOrderRequestDTO();
    }

    private void OpenEditOrderModal(Guid orderId)
    {
        var order = PermanentOrders.FirstOrDefault(o => o.Id == orderId);
        if (order != null)
        {
            UpdateOrderModel = order.Adapt<UpdateClientOrderRequestDTO>();
            OrderModalTitle = "Edit Order";
            OrderModalButtonText = "Save";
            IsOpen = true;
        }
    }

    private void OpenConfirmationModal(Guid orderId)
    {
        SelectedOrderId = orderId;
        IsConfirmationModalOpen = true;
    }

    private void CloseConfirmationModal()
    {
        IsConfirmationModalOpen = false;
        SelectedOrderId = Guid.Empty;
    }
     async Task GetProducts()
    {
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new GetProductsQuery());
        Products = result;
         Console.WriteLine("Products fetched:");
   
      
    }

    private async Task ConfirmDelete()
    {
        if (SelectedOrderId == Guid.Empty) return;

        Loading = true;
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var response = await mediator.Send(new CancelOrderCommand(SelectedOrderId));

        if (response.Flag)
        {
            ToasterService.ShowSuccess("Order deleted successfully");
            await GetOrders();
        }
        else
        {
            ToasterService.ShowError(response.Message);
        }

        Loading = false;
        CloseConfirmationModal();
    }

    private async Task SaveOrder()
    {
        Loading = true;
        ServiceResponse response;
        try
        {
            using var scope = serviceProvider.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();

            if (SelectedOrderId != Guid.Empty)
            {
                var update = UpdateOrderModel.Adapt<UpdateClientOrderRequestDTO>();
                update.OrderId = SelectedOrderId;
                response = await mediator.Send(new UpdateClientOrderCommand(update));
            }
            else
            {
                response = await mediator.Send(new CreateOrderCommand(OrderModel));
            }

            if (response.Flag)
            {
                await GetOrders();
                ToasterService.ShowSuccess(response.Message);
                CloseOrderModal();
            }
            else
            {
                ToasterService.ShowError(response.Message);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving order: {ex.Message}");
            ToasterService.ShowError("An error occurred while saving the order.");
        }
        finally
        {
            Loading = false;
        }
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            GetOrders();
        }
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            GetOrders();
        }
    }

    private void NavigateToOrderDetails(Guid orderId)
    {
        if (orderId == Guid.Empty)
        {
            ToasterService.ShowError("No order selected");
            return;
        }

        NavigationManager.NavigateTo($"/app/administration/products/orders/details/{orderId}");
    }

    private async Task GetUserIdentity()
    {
        var authState = await UserAuthState;
        User = authState.User;
    }

    private void FilterOrders(string? state)
    {
        if (string.IsNullOrEmpty(state))
        {
            TemporalOrders = PermanentOrders;
        }
        else
        {
            TemporalOrders = PermanentOrders.Where(o => o.State.Equals(state, StringComparison.OrdinalIgnoreCase));
        }
        StateHasChanged();
    }
}
